<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Print Schedule</title>
    <style>
        @page { size: A4; margin: 12mm; }
        
        html, body { 
            height: 100%; 
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f3f4f6;
            color: #111827;
        }

        .screenbar {
            max-width: 210mm;
            margin: 10px auto 0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 0 6mm;
        }
        
        .btn {
            border: 1px solid #cbd5e1;
            background: #fff;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            text-decoration: none;
            color: #111827;
            display: inline-flex;
            gap: 8px;
            align-items: center;
        }
        
        .btn:hover { background: #f8fafc; }

        .paper {
            width: 210mm;
            min-height: 297mm;
            margin: 10px auto 20px;
            background: #fff;
            border: 1px solid #d1d5db;
            box-shadow: 0 12px 40px rgba(0,0,0,.12);
            box-sizing: border-box;
        }

        .header {
            padding: 9mm 10mm 6mm 10mm;
            background: #fff;
            border-bottom: 2px solid #fff;
        }
        
        .heading {
            text-align: center;
            font-weight: 900;
            letter-spacing: .6px;
            font-size: 16px;
            margin: 0 0 6px 0;
        }
        
        .header-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: flex-end;
            margin-top: 6px;
        }
        
        .header-left {
            font-weight: 900;
            letter-spacing: .4px;
            font-size: 14px;
        }
        
        .header-right {
            font-weight: 900;
            letter-spacing: .2px;
            font-size: 13px;
            color: #111827;
            text-align: right;
            white-space: nowrap;
        }
        
        .reading {
            margin-top: 6px;
            color: #1d4ed8;
            font-weight: 900;
            font-size: 13px;
            text-align: center;
        }

        .program { padding: 0 10mm 8mm 10mm; }

        .line {
            display: grid;
            grid-template-columns: 1fr 110px;
            gap: 10px;
            padding: 3px 0;
            font-size: 13px;
        }

        .label { font-weight: 700; }
        .blue { color: #1d4ed8; font-weight: 700; text-align: right; }
        .song-blue { color: #1d4ed8; font-weight: 700; }

        .divider { height: 10px; }
        .sec { margin-top: 14px; }

        .sec-head {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0 6px;
            border-bottom: 1px solid #9ca3af;
            margin-bottom: 6px;
        }
        
        .sec-head .icon {
            width: 22px;
            height: 22px;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sec-title {
            font-weight: 900;
            letter-spacing: .3px;
            font-size: 16px;
            margin: 0;
            text-transform: uppercase;
        }
        
        .sec-title.kg { color: #0b4a77; }
        .sec-title.mm { color: #8a5b00; }
        .sec-title.pbk { color: #7a121b; }

        .part {
            display: grid;
            grid-template-columns: 1fr 110px;
            gap: 10px;
            padding: 3px 0;
            font-size: 13px;
        }
        
        .part .left b { font-weight: 900; }
        .muted { color: #374151; font-weight: 400; }

        .part.mmrow { grid-template-columns: 1fr 110px 110px; }
        .blue2 { color: #1d4ed8; font-weight: 700; text-align: right; }
        .blue3 { color: #1d4ed8; font-weight: 700; text-align: right; }

        .songline {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 13px;
            padding: 3px 0;
            font-weight: 700;
        }

        @media print {
            body { background: #fff; }
            .screenbar { display: none !important; }
            .paper { 
                margin: 0 !important; 
                border: 0; 
                box-shadow: none; 
                width: 100%;
                min-height: 100vh;
            }
        }
    </style>
</head>
<body>
    <div class="screenbar">
        <button class="btn" onclick="window.close()">‚Üê Back</button>
        <button class="btn" onclick="window.print()">üñ®Ô∏è Print</button>
    </div>

    <div class="paper">
        <div class="header">
            <div class="heading">Rolling Hills Congregation Midweek Schedule</div>

            <div class="header-row">
                <div class="header-left" id="week-title-display">‚Äî</div>
                <div class="header-right" id="meeting-date-display">‚Äî</div>
            </div>

            <div class="reading" id="week-reading-display">‚Äî</div>
        </div>

        <div class="program">
            <!-- OPENING -->
            <div class="line">
                <div class="label">Chairman</div>
                <div class="blue" id="chairman-display">‚Äî</div>
            </div>

            <div class="line">
                <div class="label">
                    <span class="song-blue" id="opening-song-display">‚ô™ Awit Blg. ‚Äî</span>
                </div>
                <div class="blue"></div>
            </div>

            <div class="line">
                <div class="label">Panalangin</div>
                <div class="blue" id="opening-prayer-display">‚Äî</div>
            </div>

            <div class="line">
                <div class="label">Pambungad na Komento (1 min.)</div>
                <div class="blue">Chairman</div>
            </div>

            <div class="divider"></div>

            <!-- KAYAMANAN -->
            <div class="sec">
                <div class="sec-head">
                    <div class="icon">üíé</div>
                    <h3 class="sec-title kg">KAYAMANAN MULA SA SALITA NG DIYOS</h3>
                </div>

                <div class="part">
                    <div class="left"><b>1.</b> <span id="kg1-title-display">‚Äî</span></div>
                    <div class="blue" id="kg1-speaker-display">‚Äî</div>
                </div>

                <div class="part">
                    <div class="left"><b>2.</b> Espirituwal na Hiyas <span class="muted">(fixed)</span></div>
                    <div class="blue" id="kg2-speaker-display">‚Äî</div>
                </div>

                <div class="part">
                    <div class="left"><b>3.</b> Pagbabasa ng Bibliya</div>
                    <div class="blue" id="kg3-reader-display">‚Äî</div>
                </div>
            </div>

            <!-- MAGING MAHUSAY -->
            <div class="sec">
                <div class="sec-head">
                    <div class="icon">üìö</div>
                    <h3 class="sec-title mm">MAGING MAHUSAY SA MINISTERYO</h3>
                </div>

                <div id="mm-rows-display">
                    <!-- MM rows will be inserted here -->
                </div>
            </div>

            <!-- PBK -->
            <div class="sec">
                <div class="sec-head">
                    <div class="icon">‚ù§Ô∏è</div>
                    <h3 class="sec-title pbk">PAMUMUHAY BILANG KRISTIYANO</h3>
                </div>

                <div class="songline">
                    <span class="song-blue" id="middle-song-display">‚ô™ Awit Blg. ‚Äî</span>
                </div>

                <div id="pbk-rows-display">
                    <!-- PBK rows will be inserted here -->
                </div>

                <div class="part">
                    <div class="left"><span class="label">Reader Phar</span></div>
                    <div class="blue" id="cbs-phar-display">‚Äî</div>
                </div>

                <div class="part">
                    <div class="left"><span class="label">Reader Bible</span></div>
                    <div class="blue" id="cbs-bible-display">‚Äî</div>
                </div>
            </div>

            <div class="divider"></div>

            <!-- CLOSING -->
            <div class="line">
                <div class="label">Pangwakas na Komento (3 min.)</div>
                <div class="blue">Chairman</div>
            </div>

            <div class="line">
                <div class="label">
                    <span class="song-blue" id="closing-song-display">‚ô™ Awit Blg. ‚Äî</span>
                </div>
                <div class="blue"></div>
            </div>

            <div class="line">
                <div class="label">Panalangin</div>
                <div class="blue" id="closing-prayer-display">‚Äî</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        
        function h(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'short'
            });
        }

        async function loadPrintData() {
            const params = new URLSearchParams(window.location.search);
            const meetingId = params.get('meeting_id');
            
            if (!meetingId) {
                document.body.innerHTML = '<div style="padding:40px;text-align:center;">No meeting specified</div>';
                return;
            }

            try {
                // Load meeting details
                const response = await fetch(`${API_URL}/meetings/${meetingId}`);
                if (!response.ok) throw new Error('Failed to load meeting');
                
                const data = await response.json();
                const meeting = data.meeting;
                const assignments = data.assignments;

                // Load people
                const peopleResponse = await fetch(`${API_URL}/people`);
                const people = await peopleResponse.json();
                
                const personName = (id) => {
                    const person = people.find(p => p.id == id);
                    return person ? person.full_name : '‚Äî';
                };

                // Display week info
                document.getElementById('week-title-display').textContent = meeting.week_title || '‚Äî';
                document.getElementById('meeting-date-display').textContent = formatDate(meeting.meeting_date);
                document.getElementById('week-reading-display').textContent = meeting.week_reading || '‚Äî';

                // Display songs
                const openingSong = meeting.opening_song_no ? 
                    `‚ô™ Awit Blg. ${meeting.opening_song_no} ${meeting.opening_song_title || ''}` : 
                    '‚ô™ Awit Blg. ‚Äî';
                document.getElementById('opening-song-display').textContent = openingSong;

                const middleSong = meeting.middle_song_no ? 
                    `‚ô™ Awit Blg. ${meeting.middle_song_no} ${meeting.middle_song_title || ''}` : 
                    '‚ô™ Awit Blg. ‚Äî';
                document.getElementById('middle-song-display').textContent = middleSong;

                const closingSong = meeting.closing_song_no ? 
                    `‚ô™ Awit Blg. ${meeting.closing_song_no} ${meeting.closing_song_title || ''}` : 
                    '‚ô™ Awit Blg. ‚Äî';
                document.getElementById('closing-song-display').textContent = closingSong;

                // Display assignments
                document.getElementById('chairman-display').textContent = personName(assignments.chairman);
                document.getElementById('opening-prayer-display').textContent = personName(assignments.opening_prayer);
                document.getElementById('closing-prayer-display').textContent = personName(assignments.closing_prayer);

                document.getElementById('kg1-title-display').textContent = assignments.kayamanan_title || '‚Äî';
                document.getElementById('kg1-speaker-display').textContent = personName(assignments.kayamanan);
                document.getElementById('kg2-speaker-display').textContent = personName(assignments.hiyas);
                document.getElementById('kg3-reader-display').textContent = personName(assignments.bible_reading);

                document.getElementById('cbs-phar-display').textContent = personName(assignments.cbs_reader_phar);
                document.getElementById('cbs-bible-display').textContent = personName(assignments.cbs_reader_bible);

                // Display MM rows
                const mmContainer = document.getElementById('mm-rows-display');
                if (data.mm_rows && data.mm_rows.length > 0) {
                    mmContainer.innerHTML = data.mm_rows.map(row => `
                        <div class="part mmrow">
                            <div class="left"><b>${h(row.part_no || '‚Äî')}.</b> ${h(row.part_title || '‚Äî')}</div>
                            <div class="blue2">${personName(row.publisher_id)}</div>
                            <div class="blue3">${personName(row.householder_id)}</div>
                        </div>
                    `).join('');
                } else {
                    mmContainer.innerHTML = '<div class="part"><div class="left muted">No MM parts assigned</div></div>';
                }

                // Display PBK rows
                const pbkContainer = document.getElementById('pbk-rows-display');
                if (data.pbk_rows && data.pbk_rows.length > 0) {
                    pbkContainer.innerHTML = data.pbk_rows.map(row => `
                        <div class="part">
                            <div class="left"><b>${h(row.part_no || '‚Äî')}.</b> ${h(row.part_title || '‚Äî')}</div>
                            <div class="blue">${personName(row.speaker_id)}</div>
                        </div>
                    `).join('');
                } else {
                    pbkContainer.innerHTML = '<div class="part"><div class="left muted">No PBK parts assigned</div></div>';
                }

            } catch (error) {
                console.error('Error:', error);
                document.body.innerHTML = '<div style="padding:40px;text-align:center;">Error loading meeting data</div>';
            }
        }

        // Load data when page loads
        loadPrintData();
    </script>
</body>
</html>
